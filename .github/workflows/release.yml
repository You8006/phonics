name: Release

on:
  push:
    tags: ["v*"]
  workflow_dispatch:
    inputs:
      build_number:
        description: "ビルド番号 (空欄=run number)"
        required: false
        type: string
      platform:
        description: "ビルド対象"
        required: true
        type: choice
        options:
          - ios
          # - android  # 将来有効化
        default: ios

permissions:
  contents: write

jobs:
  build-ios:
    if: >-
      github.event_name == 'push' ||
      github.event.inputs.platform == 'ios'
    runs-on: macos-latest
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - run: flutter pub get
      - run: flutter gen-l10n

      - name: Install Apple Certificate
        env:
          P12_BASE64: ${{ secrets.P12_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          CERT=$RUNNER_TEMP/cert.p12
          KC=$RUNNER_TEMP/app-signing.keychain-db
          echo -n "$P12_BASE64" | base64 --decode -o $CERT
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KC
          security set-keychain-settings -lut 21600 $KC
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KC
          security import $CERT -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KC
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" $KC
          security list-keychain -d user -s $KC

      - name: Install Provisioning Profile
        env:
          PROVISIONING_PROFILE_BASE64: ${{ secrets.PROVISIONING_PROFILE_BASE64 }}
        run: |
          PP=$RUNNER_TEMP/build_pp.mobileprovision
          echo -n "$PROVISIONING_PROFILE_BASE64" | base64 --decode -o $PP
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp $PP ~/Library/MobileDevice/Provisioning\ Profiles/

      - name: Generate ExportOptions.plist
        env:
          TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          BUNDLE_ID: ${{ secrets.APP_BUNDLE_ID }}
          PROFILE_NAME: ${{ secrets.PROVISIONING_PROFILE_NAME }}
        run: |
          cat > ios/ExportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key><string>app-store-connect</string>
            <key>teamID</key><string>${TEAM_ID}</string>
            <key>uploadBitcode</key><false/>
            <key>uploadSymbols</key><true/>
            <key>signingStyle</key><string>manual</string>
            <key>provisioningProfiles</key>
            <dict><key>${BUNDLE_ID}</key><string>${PROFILE_NAME}</string></dict>
          </dict>
          </plist>
          EOF

      - name: Build IPA
        run: |
          BUILD_NUM=${{ github.event.inputs.build_number || github.run_number }}
          flutter build ipa --release \
            --build-number=$BUILD_NUM \
            --export-options-plist=ios/ExportOptions.plist

      - name: Upload to TestFlight
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}
        run: |
          mkdir -p ~/private_keys
          echo -n "$ASC_KEY_BASE64" | base64 --decode > ~/private_keys/AuthKey_${ASC_KEY_ID}.p8
          IPA=$(find build/ios/ipa -name "*.ipa" | head -1)
          xcrun altool --upload-app --type ios --file "$IPA" \
            --apiKey "$ASC_KEY_ID" --apiIssuer "$ASC_ISSUER_ID"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-${{ github.run_number }}
          path: build/ios/ipa/*.ipa
          retention-days: 30

      - name: Attach to Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: build/ios/ipa/*.ipa
          generate_release_notes: true

      - name: Cleanup
        if: always()
        run: |
          security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true
          rm -f $RUNNER_TEMP/cert.p12 $RUNNER_TEMP/build_pp.mobileprovision
          rm -rf ~/private_keys

  # ─── Android (将来有効化) ───
  # build-android:
  #   if: >-
  #     github.event_name == 'push' ||
  #     github.event.inputs.platform == 'android'
  #   runs-on: ubuntu-latest
  #   timeout-minutes: 30
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: subosito/flutter-action@v2
  #       with: { channel: stable }
  #     - uses: actions/setup-java@v4
  #       with: { distribution: temurin, java-version: 17 }
  #     - run: flutter pub get
  #     - run: flutter gen-l10n
  #     - name: Decode keystore
  #       env:
  #         KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
  #       run: echo -n "$KEYSTORE_BASE64" | base64 -d > android/upload-keystore.jks
  #     - name: Build AAB
  #       env:
  #         KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
  #         KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
  #         STORE_PASSWORD: ${{ secrets.ANDROID_STORE_PASSWORD }}
  #       run: |
  #         BUILD_NUM=${{ github.event.inputs.build_number || github.run_number }}
  #         flutter build appbundle --release --build-number=$BUILD_NUM
  #     - uses: actions/upload-artifact@v4
  #       with:
  #         name: android-${{ github.run_number }}
  #         path: build/app/outputs/bundle/release/*.aab
  #     - name: Attach to Release
  #       if: startsWith(github.ref, 'refs/tags/')
  #       uses: softprops/action-gh-release@v2
  #       with:
  #         files: build/app/outputs/bundle/release/*.aab
